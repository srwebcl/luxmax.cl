---

---

<section
    id="contacto"
    class="py-16 md:py-24 bg-blue-50 relative overflow-hidden"
>
    <!-- Decorative Blobs -->
    <div
        class="absolute -left-20 top-20 w-96 h-96 bg-blue-200/40 rounded-full blur-[100px] pointer-events-none"
    >
    </div>
    <div
        class="absolute -right-20 bottom-20 w-96 h-96 bg-orange-200/40 rounded-full blur-[100px] pointer-events-none"
    >
    </div>

    <div class="container mx-auto px-4 relative z-10">
        <div
            class="max-w-3xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 contact-container"
        >
            <div
                class="bg-gradient-to-r from-blue-900 to-slate-900 py-10 px-8 text-white text-center relative overflow-hidden"
            >
                <div
                    class="absolute inset-0 bg-grid-white/[0.05] bg-[length:20px_20px]"
                >
                </div>
                <h2 class="text-3xl font-black relative z-10">
                    ¬øNecesitas un presupuesto?
                </h2>
                <p class="text-blue-100 mt-2 text-lg relative z-10">
                    Escr√≠benos y un experto te contactar√° en minutos.
                </p>
            </div>

            <form class="p-8 md:p-12 space-y-6" id="contactForm">
                <!-- Name & Phone Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label
                            for="name"
                            class="block text-sm font-bold text-slate-700 mb-2 ml-1"
                            >Nombre Completo</label
                        >
                        <input
                            type="text"
                            id="name"
                            name="name"
                            required
                            placeholder="Ej: Juan P√©rez"
                            class="w-full px-5 h-14 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder-slate-400 font-medium"
                        />
                    </div>
                    <div>
                        <label
                            for="phone"
                            class="block text-sm font-bold text-slate-700 mb-2 ml-1"
                            >Tel√©fono</label
                        >
                        <input
                            type="tel"
                            id="phone"
                            name="phone"
                            required
                            placeholder="+56 9 ..."
                            class="w-full px-5 h-14 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder-slate-400 font-medium"
                        />
                    </div>
                </div>

                <!-- Email Field (Added as requested) -->
                <div>
                    <label
                        for="email"
                        class="block text-sm font-bold text-slate-700 mb-2 ml-1"
                        >Correo Electr√≥nico</label
                    >
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        placeholder="tu@correo.com"
                        class="w-full px-5 h-14 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder-slate-400 font-medium"
                    />
                </div>

                <!-- Location & Device Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label
                            for="comuna"
                            class="block text-sm font-bold text-slate-700 mb-2 ml-1"
                            >Comuna</label
                        >
                        <div class="relative">
                            <select
                                id="comuna"
                                name="comuna"
                                class="w-full px-5 h-14 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all appearance-none font-medium cursor-pointer"
                            >
                                <option value="La Serena">La Serena</option>
                                <option value="Coquimbo">Coquimbo</option>
                                <option value="Ovalle">Ovalle</option>
                                <option value="Otra">Otra</option>
                            </select>
                            <div
                                class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500"
                            >
                                ‚ñº
                            </div>
                        </div>
                    </div>

                    <div>
                        <label
                            for="artefacto"
                            class="block text-sm font-bold text-slate-700 mb-2 ml-1"
                            >Artefacto</label
                        >
                        <div class="relative">
                            <select
                                id="artefacto"
                                name="artefacto"
                                class="w-full px-5 h-14 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all appearance-none font-medium cursor-pointer"
                            >
                                <option value="Lavadora">Lavadora</option>
                                <option value="Secadora">Secadora</option>
                                <option value="Cocina">Cocina</option>
                                <option value="Encimera">Encimera</option>
                            </select>
                            <div
                                class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500"
                            >
                                ‚ñº
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Problema -->
                <div>
                    <label
                        for="problem"
                        class="block text-sm font-bold text-slate-700 mb-2 ml-1"
                        >Describe el problema</label
                    >
                    <textarea
                        id="problem"
                        name="problem"
                        rows="3"
                        placeholder="Ej: No centrifuga, hace ruido extra√±o, pantalla parpadea..."
                        class="w-full px-5 py-4 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all placeholder-slate-400 resize-none font-medium"
                    ></textarea>
                </div>

                <!-- Submit Button -->
                <button
                    type="submit"
                    id="submitBtn"
                    class="w-full bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-400 hover:to-orange-500 text-white font-black h-16 rounded-xl shadow-lg shadow-orange-500/30 transition-all duration-300 transform hover:-translate-y-1 text-xl flex items-center justify-center gap-3 overflow-hidden relative group"
                >
                    <span
                        class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700"
                    ></span>
                    <span id="btnText">üöÄ Solicitar Visita T√©cnica</span>
                    <span id="btnLoader" class="hidden">
                        <svg
                            class="animate-spin h-5 w-5 text-white"
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                        >
                            <circle
                                class="opacity-25"
                                cx="12"
                                cy="12"
                                r="10"
                                stroke="currentColor"
                                stroke-width="4"></circle>
                            <path
                                class="opacity-75"
                                fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                            ></path>
                        </svg>
                    </span>
                </button>

                <p
                    class="text-center text-sm text-slate-500 mt-4 flex items-center justify-center gap-2"
                >
                    <svg
                        class="w-4 h-4 text-green-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                        ></path></svg
                    >
                    Tus datos est√°n 100% seguros.
                </p>
            </form>
        </div>
    </div>
</section>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    gsap.from(".contact-container", {
        scrollTrigger: {
            trigger: "#contacto",
            start: "top 75%",
        },
        y: 60,
        opacity: 0,
        duration: 1,
        ease: "power3.out",
        clearProps: "all",
    });

    // Form Handling
    const form = document.getElementById("contactForm") as HTMLFormElement;
    const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
    const btnText = document.getElementById("btnText");
    const btnLoader = document.getElementById("btnLoader");

    declare const grecaptcha: any; // Type declaration for global grecaptcha

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // 1. UI Loading State
            submitBtn.disabled = true;
            submitBtn.classList.add("opacity-75", "cursor-not-allowed");
            btnText?.classList.add("hidden");
            btnLoader?.classList.remove("hidden");

            const formData = new FormData(form);
            const data: any = Object.fromEntries(formData.entries());

            try {
                // 2. Validaci√≥n de Seguridad (Wait for reCAPTCHA)
                const token = await new Promise<string>((resolve, reject) => {
                    // Caso A: grecaptcha ya carg√≥
                    if (typeof grecaptcha !== "undefined") {
                        grecaptcha.ready(() => {
                            grecaptcha
                                .execute(
                                    "6Lc-ZTssAAAAACTEL6IdjzMRAKFUkD3B6MP5IzF8",
                                    { action: "submit" },
                                )
                                .then(resolve)
                                .catch(reject);
                        });
                    }
                    // Caso B: grecaptcha no ha cargado (AdBlocker o Red Lenta)
                    else {
                        // Esperar m√°x 2 segundos
                        let attempts = 0;
                        const checkInterval = setInterval(() => {
                            attempts++;
                            if (typeof grecaptcha !== "undefined") {
                                clearInterval(checkInterval);
                                grecaptcha.ready(() => {
                                    grecaptcha
                                        .execute(
                                            "6Lc-ZTssAAAAACTEL6IdjzMRAKFUkD3B6MP5IzF8",
                                            { action: "submit" },
                                        )
                                        .then(resolve)
                                        .catch(reject);
                                });
                            } else if (attempts > 20) {
                                // 2 segundos timeout
                                clearInterval(checkInterval);
                                reject(
                                    new Error(
                                        "No se pudo cargar el sistema de seguridad (reCAPTCHA). Si usas un bloqueador de anuncios, por favor desact√≠valo.",
                                    ),
                                );
                            }
                        }, 100);
                    }
                });

                data.recaptchaToken = token;

                // 3. Env√≠o al Backend
                const response = await fetch("/api/send", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                // Manejo de respuesta
                const contentType = response.headers.get("content-type");
                let responseData;
                if (contentType && contentType.includes("application/json")) {
                    responseData = await response.json();
                } else {
                    responseData = { message: await response.text() };
                }

                if (response.ok) {
                    window.location.href = "/gracias";
                } else {
                    throw new Error(
                        responseData.message || "Error al enviar solicitud.",
                    );
                }
            } catch (error: any) {
                console.error("Error Form:", error);
                alert(`‚ö†Ô∏è ${error.message}`);
                resetBtn();
            }
        });
    }

    function resetBtn() {
        submitBtn.disabled = false;
        submitBtn.classList.remove("opacity-75", "cursor-not-allowed");
        btnText?.classList.remove("hidden");
        btnLoader?.classList.add("hidden");
    }
</script>
